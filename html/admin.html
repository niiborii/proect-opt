<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å ‚Äî STUCK</title>
  <link rel="stylesheet" href="../css/style.css"/>
</head>
<body>
<header>
  <!-- Header –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
</header>

<main>
  <div class="admin-container">
    <div class="welcome-message">
      <h1>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å STUCK</h1>
      <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="adminName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>!</p>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="totalUsers">0</h3>
        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
      </div>
      <div class="stat-card">
        <h3 id="totalGames">0</h3>
        <p>–ò–≥—Ä –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</p>
      </div>
      <div class="stat-card">
        <h3 id="totalAdmins">0</h3>
        <p>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</p>
      </div>
    </div>

    <div class="admin-section">
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
      <div class="crud-form">
        <input type="email" id="newUserEmail" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="password" id="newUserPassword" placeholder="–ü–∞—Ä–æ–ª—å">
        <select id="newUserRole" style="padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
          <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
          <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
        </select>
        <button id="addUserBtn" class="btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
      </div>
      <table id="usersTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>–†–æ–ª—å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="admin-section">
  <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–∞–º–∏</h2>
  <div class="crud-form">
    <input id="gTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã">
    <input id="gPrice" type="number" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)">
    <input id="gCover" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É">
    <input id="gPage" placeholder="–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–∏—Å–∞–Ω–∏—è">
    <div style="grid-column: 1 / -1;">
      <label for="gAvatarUpload" style="display: block; margin-bottom: 8px; font-weight: 500;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É:</label>
      <input type="file" id="gAvatarUpload" accept="image/*" style="margin-bottom: 10px;">
      <div id="avatarPreview" style="margin-top: 10px;"></div>
    </div>
    <button id="addGameBtn" class="btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É</button>
  </div>
  <table id="gamesTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–¶–µ–Ω–∞</th>
        <th>–û–±–ª–æ–∂–∫–∞</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
  </div>
</main>

<footer>
  <!-- Footer –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
</footer>

<script src="../js/bundle.js"></script>
<script src="../js/components.js"></script>
<script>
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
  const currentUser = Auth.current();
  if (!currentUser || currentUser.role !== 'admin') {
    alert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω! –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
    window.location.href = 'login.html';
  }

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∞
  document.getElementById('adminName').textContent = currentUser.email;

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  async function loadStats() {
    const users = await DB.getUsers();
    const games = await DB.getCatalogue();
    const admins = users.filter(u => u.role === 'admin').length;
    
    document.getElementById('totalUsers').textContent = users.length;
    document.getElementById('totalGames').textContent = games.length;
    document.getElementById('totalAdmins').textContent = admins;
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  async function loadUsers() {
    const users = await DB.getUsers();
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = users.map(user => `
      <tr>
        <td>${user.email}</td>
        <td>${user.role}</td>
        <td>
          <button class="btn-small btn-danger" onclick="deleteUser('${user.email}')">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="btn-small btn-warning" onclick="toggleRole('${user.email}')">
            ${user.role === 'admin' ? '–°–¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º' : '–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º'}
          </button>
        </td>
      </tr>
    `).join('');
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä
  async function loadGames() {
    const games = await DB.getCatalogue();
    const tbody = document.querySelector('#gamesTable tbody');
    tbody.innerHTML = games.map(game => `
      <tr>
        <td>${game.id}</td>
        <td>${game.title}</td>
        <td>${game.price} ‚ÇΩ</td>
        <td>
          <img src="${game.cover}" alt="${game.title}" style="width: 50px; height: 70px; object-fit: cover; cursor: pointer;" 
               onclick="changeGameAvatar(${game.id})" title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É">
        </td>
        <td>
          <button class="btn-small btn-danger" onclick="deleteGame(${game.id})">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="btn-small btn-warning" onclick="editGame(${game.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </td>
      </tr>
    `).join('');
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  window.deleteUser = async function(email) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${email}?`)) {
      await DB.deleteUser(email);
      await loadUsers();
      await loadStats();
    }
  };

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  window.toggleRole = async function(email) {
    const users = await DB.getUsers();
    const user = users.find(u => u.email === email);
    if (user) {
      user.role = user.role === 'admin' ? 'user' : 'admin';
      await DB.saveUsers(users);
      await loadUsers();
      await loadStats();
    }
  };

  // –£–¥–∞–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
  window.deleteGame = async function(id) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏–≥—Ä—É?')) {
      await DB.deleteGame(id);
      await loadGames();
      await loadStats();
    }
  };

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–≥—Ä—ã
  window.editGame = async function(id) {
    const games = await DB.getCatalogue();
    const game = games.find(g => g.id === id);
    if (game) {
      const newTitle = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', game.title);
      const newPrice = prompt('–ù–æ–≤–∞—è —Ü–µ–Ω–∞:', game.price);
      
      if (newTitle && newPrice) {
        game.title = newTitle;
        game.price = parseInt(newPrice);
        await DB.saveCatalogue(games);
        await loadGames();
      }
    }
  };

  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ –∏–≥—Ä—ã
  window.changeGameAvatar = async function(id) {
    const games = await DB.getCatalogue();
    const game = games.find(g => g.id === id);
    if (!game) return;

    const newAvatarUrl = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É:', game.cover);
    if (newAvatarUrl && newAvatarUrl !== game.cover) {
      game.cover = newAvatarUrl;
      await DB.saveCatalogue(games);
      await loadGames();
      alert('–ê–≤–∞—Ç–∞—Ä–∫–∞ –∏–≥—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –¥–ª—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Supabase)
  document.getElementById('gAvatarUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('avatarPreview');
    
    if (file) {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 5MB.');
        e.target.value = '';
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
      if (!file.type.startsWith('image/')) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
        e.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.innerHTML = `
          <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 8px;">
          <p style="font-size: 12px; color: #666; margin-top: 5px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (—Ñ–∞–π–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Supabase)</p>
        `;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Supabase
        preview.dataset.uploadFile = 'true';
      };
      reader.readAsDataURL(file);
    } else {
      preview.innerHTML = '';
      delete preview.dataset.uploadFile;
    }
  });

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  document.getElementById('addUserBtn').onclick = async function() {
    const email = document.getElementById('newUserEmail').value.trim();
    const password = document.getElementById('newUserPassword').value.trim();
    const role = document.getElementById('newUserRole').value;
    
    if (!email || !password) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
      return;
    }
    
    try {
      const result = await Auth.register(email, password);
      if (result.ok) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        const users = await DB.getUsers();
        const user = users.find(u => u.email === email);
        if (user && role !== 'user') {
          user.role = role;
          await DB.saveUsers(users);
        }
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPassword').value = '';
        document.getElementById('newUserRole').value = 'user';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        await loadUsers();
        await loadStats();
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!');
      } else {
        alert(result.msg);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    }
  };

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã (—Å –∑–∞–≥—Ä—É–∑–∫–æ–π –≤ Supabase)
  document.getElementById('addGameBtn').onclick = async function() {
    const title = document.getElementById('gTitle').value.trim();
    const price = parseInt(document.getElementById('gPrice').value);
    const cover = document.getElementById('gCover').value.trim();
    const page = document.getElementById('gPage').value.trim();
    const avatarPreview = document.getElementById('avatarPreview');
    const fileInput = document.getElementById('gAvatarUpload');
    
    if (!title || !price) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É!');
      return;
    }
    
    let coverUrl = cover;
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
    if (fileInput.files.length > 0 && avatarPreview.dataset.uploadFile) {
      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const btn = document.getElementById('addGameBtn');
        const originalText = btn.textContent;
        btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
        btn.disabled = true;
        
        const file = fileInput.files[0];
        coverUrl = await SupabaseStorage.uploadFile(file, file.name);
        
        btn.textContent = originalText;
        btn.disabled = false;
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
        return;
      }
    } else if (!coverUrl) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ —Å—Å—ã–ª–∫–∏, –Ω–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º placeholder
      coverUrl = `https://via.placeholder.com/300x400/FF6B35/FFFFFF?text=${encodeURIComponent(title)}`;
    }
    
    const game = {
      title: title,
      price: price,
      cover: coverUrl,
      detailPage: page || 'game-details.html',
      genre: "–≠–∫—à–µ–Ω, RPG",
      developer: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫",
      publisher: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–∑–¥–∞—Ç–µ–ª—å",
      releaseDate: "2024",
      description: "–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∞—è –∏–≥—Ä–∞ —Å –æ—Ç–ª–∏—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–æ–π –∏ –≥–µ–π–º–ø–ª–µ–µ–º.",
      features: ["–û—Ç–ª–∏—á–Ω–∞—è –≥—Ä–∞—Ñ–∏–∫–∞", "–£–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –≥–µ–π–º–ø–ª–µ–π", "–ú–Ω–æ–∂–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π"]
    };
    
    DB.addGame(game);
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('gTitle').value = '';
    document.getElementById('gPrice').value = '';
    document.getElementById('gCover').value = '';
    document.getElementById('gPage').value = '';
    document.getElementById('gAvatarUpload').value = '';
    avatarPreview.innerHTML = '';
    delete avatarPreview.dataset.uploadFile;
    
    loadGames();
    loadStats();
    alert('–ò–≥—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  loadStats();
  loadUsers();
  loadGames();

  // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏ —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
  window.changeGameAvatar = async function(id) {
    const games = await DB.getCatalogue();
    const game = games.find(g => g.id === id);
    if (!game) return;

    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.createElement('div');
    modal.className = 'avatar-modal';
    modal.style.display = 'block';
    
    modal.innerHTML = `
      <div class="avatar-modal-content">
        <h3>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ –¥–ª—è "${game.title}"</h3>
        
        <div class="avatar-options">
          <div class="avatar-option" onclick="selectAvatarOption('url')">
            <strong>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</strong>
            <p style="font-size: 14px; color: #666; margin: 5px 0 0 0;">–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
          </div>
          
          <div class="avatar-option" onclick="selectAvatarOption('upload')">
            <strong>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</strong>
            <p style="font-size: 14px; color: #666; margin: 5px 0 0 0;">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</p>
          </div>
        </div>
        
        <div id="avatarUrlSection" style="display: none;">
          <input type="text" id="newAvatarUrl" placeholder="https://example.com/image.jpg" 
                 value="${game.cover}" style="width: 100%; padding: 10px; margin: 10px 0;">
        </div>
        
        <div id="avatarUploadSection" style="display: none;">
          <div class="upload-area" onclick="document.getElementById('avatarFileInput').click()">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</div>
            <div class="upload-hint">PNG, JPG –¥–æ 2MB</div>
          </div>
          <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
          <div id="avatarUploadPreview" style="margin: 10px 0;"></div>
        </div>
        
        <div class="avatar-preview">
          <strong>–¢–µ–∫—É—â–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞:</strong>
          <div style="margin-top: 10px;">
            <img src="${game.cover}" alt="–¢–µ–∫—É—â–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞" style="max-width: 150px;">
          </div>
        </div>
        
        <div class="avatar-modal-buttons">
          <button class="btn-secondary" onclick="closeAvatarModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn-primary" onclick="saveGameAvatar(${id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    document.getElementById('avatarFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const preview = document.getElementById('avatarUploadPreview');
      
      if (file && file.size > 2 * 1024 * 1024) {
        alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 2MB.');
        return;
      }
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `
            <strong>–ù–æ–≤–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞:</strong>
            <div style="margin-top: 5px;">
              <img src="${e.target.result}" style="max-width: 150px; border-radius: 4px;">
            </div>
          `;
          preview.dataset.fileData = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
  window.selectAvatarOption = function(option) {
    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
    event.target.closest('.avatar-option').classList.add('selected');
    
    document.getElementById('avatarUrlSection').style.display = option === 'url' ? 'block' : 'none';
    document.getElementById('avatarUploadSection').style.display = option === 'upload' ? 'block' : 'none';
  };

  window.closeAvatarModal = function() {
    const modal = document.querySelector('.avatar-modal');
    if (modal) {
      document.body.removeChild(modal);
    }
  };

  window.saveGameAvatar = async function(id) {
    const games = await DB.getCatalogue();
    const game = games.find(g => g.id === id);
    const selectedOption = document.querySelector('.avatar-option.selected');
    
    if (!selectedOption) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏!');
      return;
    }
    
    let newAvatarUrl = game.cover;
    
    if (selectedOption.textContent.includes('—Å—Å—ã–ª–∫–∞')) {
      const urlInput = document.getElementById('newAvatarUrl').value.trim();
      if (!urlInput) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!');
        return;
      }
      newAvatarUrl = urlInput;
    } else if (selectedOption.textContent.includes('—Ñ–∞–π–ª')) {
      const fileInput = document.getElementById('avatarFileInput');
      if (!fileInput.files.length) {
        alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª!');
        return;
      }
      
      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const modal = document.querySelector('.avatar-modal-content');
        const saveBtn = modal.querySelector('.btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤ Supabase...';
        saveBtn.disabled = true;
        
        const file = fileInput.files[0];
        newAvatarUrl = await SupabaseStorage.uploadFile(file, file.name);
        
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + error.message);
        return;
      }
    }
    
    if (newAvatarUrl !== game.cover) {
      game.cover = newAvatarUrl;
      await DB.saveCatalogue(games);
      await loadGames();
      alert('–ê–≤–∞—Ç–∞—Ä–∫–∞ –∏–≥—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
    }
    
    closeAvatarModal();
  };

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('avatar-modal')) {
      closeAvatarModal();
    }
  });

  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
</script>
  
</script>
</body>
</html>